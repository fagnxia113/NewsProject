# 行业新闻智能分析应用 - 新闻分析逻辑说明（根据反馈调整）

## 1. 整体架构

应用采用前后端分离架构：
- 后端：NestJS + Prisma ORM + SQLite数据库
- 前端：React + TypeScript + NextUI组件库
- 通信：使用TRPC进行类型安全的API调用

## 2. 核心分析流程

### 2.1 数据采集
1. 用户通过微信公众号历史文章链接添加信息源
2. 系统定期或手动触发文章采集任务
3. 采集的文章存储在Article表中，初始状态为未处理(isProcessed=false)

### 2.2 智能分析主流程
当用户触发分析任务时，系统按以下步骤处理文章：

#### 步骤1：爬虫抓取文章内容
- 在LLM分析之前，先使用爬虫服务爬取文章链接的内容
- 增加反爬虫防护机制，如设置请求间隔、随机User-Agent等
- 将爬取到的内容存储到文章记录中

#### 步骤2：LLM分析（llm.service.ts）
1. 获取爬取到的文章内容和预设的行业/类型信息
2. 构造提示词，要求LLM：
   - 判断文章是否与预设行业和类型相关
   - 如果相关，将文章拆分为多个独立新闻事件
   - 为每个事件提取：
     * 标题
     * 简要（从文章中提取，可轻微改写但不得变更原文含义，字数严格控制在200字以内）
     * 原网址链接
   
3. 解析LLM响应，生成结构化新闻列表
4. 注意：不提取类型和相关实体

#### 步骤3：重复检测（deduplication.service.ts）
1. 针对分析出的新闻进行重复检测（而不是针对原始文章）
2. 检查新闻是否与历史分析结果重复
3. 如果发现重复，进行相应标记

#### 步骤4：结果存储
- 将分析出的新闻结果保存到数据库
- 更新文章处理状态和时间

### 2.3 批量处理
- 支持批量处理指定文章
- 支持处理所有未处理文章
- 考虑并发问题，按文章依次进行分析
- 异步执行，避免阻塞主线程

## 3. 核心数据模型

### 3.1 Article（文章）
- id: 文章ID
- title: 标题
- content: 内容
- publishTime: 发布时间
- industry: 所属行业
- newsType: 新闻类型
- confidence: 分类置信度
- isProcessed: 是否已处理
- isDuplicate: 是否重复
- duplicateGroupId: 重复组ID

### 3.2 Industry（行业）
- id: ID
- name: 名称
- description: 描述
- isActive: 是否启用

### 3.3 NewsType（新闻类型）
- id: ID
- name: 名称
- description: 描述
- isActive: 是否启用

## 4. 关键功能模块

### 4.1 AnalysisService（分析服务）
- processArticle: 处理单篇文章
- batchProcessArticles: 批量处理文章
- listIndustries: 获取行业列表
- listNewsTypes: 获取新闻类型列表
- getStats: 获取统计信息

### 4.2 LlmService（大模型服务）
- analyzeArticle: 使用LLM分析文章
- buildAnalysisPrompt: 构造分析提示词
- parseAnalysisResponse: 解析LLM响应

### 4.3 DeduplicationService（去重服务）
- checkDuplicate: 检查文章是否重复
- calculateSimilarity: 计算文章相似度
- checkDuplicateWithLLM: 使用LLM检查重复

### 4.4 CrawlerService（爬虫服务）
- crawlArticleContent: 爬取文章内容
- crawlMpArticles: 爬取公众号文章列表

## 5. 前端展示逻辑

### 5.1 分析结果页面
- 不显示统计概览和行业分布
- 筛选功能（按分析完成时间等）
- 文章列表展示（标题、摘要、原网址链接）
- 批量操作（选择、导出、删除等）
- 增加当前分析的实时进展显示

### 5.2 置信度显示
- 不显示置信度

## 6. 配置管理

### 6.1 LLM配置
- 支持多种大模型（默认智谱AI）
- 可配置API密钥、URL、模型名称等
- 支持启用/禁用LLM去重功能

### 6.2 行业和类型管理
- 可在设置中心添加、编辑、删除行业和新闻类型
- 支持设置优先级和启用状态

## 7. 定时任务

### 7.1 定期分析
- 不使用定时任务

## 8. 错误处理和日志

- 详细的错误日志记录
- 失败任务的重试机制
- 用户友好的错误提示

## 9. 性能优化

- 异步处理避免阻塞
- 数据库索引优化
- 缓存机制减少重复计算
- 分页加载减少内存占用
